---
title: "DBopen"
author: "Philipp Ottolinger"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## DBopen - Query the DB-Open-Data timetable API

In 2015 *Deutsche Bahn*, the German state-owned railway company, started an [Open-Data project](http://data.deutschebahn.com/) including access to their [timetable API](http://data.deutschebahn.com/apis/fahrplan/). At the moment this service is available for long-distance traffic only. This package provides some functionality to fetch data from the timetable API easily.

Please be aware that an authentication key is required to work with `DBopen`[^1]. The team of DB-Open-Date issues API keys to anyone sending an E-Mail to [dbopendata@deutschebahn.com](mailto:dbopendata@deutschebahn.com).

### Get the API specific station ID

Every train station has a unique API specific ID that is used to identify the station in API queries. `getStopID()` can be used to get the ID of the station that best matches the character pattern `station`. To look up the `stopID` for Hamburg Main Station using the German expression *Hamburg Hbf* where *Hbf* is the clipped form of *Hauptbahnhof* (`<Ger.>` *Main Station*):

```{r, include = F}
source("authKey.R")
```

```{r}
library(DBopen)
getStopID(station = "Hamburg Hbf", authKey = authKey)
```

For further processing the `stopID` gets stored:

```{r}
stopID <- getStopID(station = "Hamburg Hbf", authKey = authKey)$id
```

### Fetch departure and arrival boards

With the just fetched `stopID` one can continue and fetch departure and arrival boards. Both functions, `departureBoard()` and `arrivalBoard()`, require identical input:

* a `stopID` identifying a station
* a `date` for which the data shall be fetched
* a `time` of day which the data shall be fetched
* the API authentication key `authKey` and
* a logical value (`refs`) indicating whether additional train specific information shall be fetched

```{r}
departureBoard(stopID = stopID, date = "2016-09-01", time = "08:00", authKey = authKey)
```
```{r}
arrivalBoard(stopID = stopID, date = "2016-09-01", time = "18:00", authKey = authKey)
```

When setting `refs = FALSE` (as is per default) `departureBoard()` and `arrivalBoard()` both return a `data.frame`. With setting `refs = TRUE` this behaviour changes: Both functions then return a list containing 

* the departure or arrival board in `$departureBoard` or `$arrivalBoard`
* a second `data.frame` containing a train specific reference URL for a further API call.

This second `data.frame` can be found in `$departureBoardRef` or `$arrivalBoardRef` depending on which function you use. For the above departure board `$departureBoardRef` looks like follows:

```{r}
dep <- departureBoard(stopID = stopID, 
                      date = "2016-09-01", 
                      time = "08:00", 
                      authKey = authKey, 
                      refs = TRUE)
```
```{r, include = F}
dep$departureBoardRef$Ref <- "..."
```
```{r}
dep$departureBoardRef
```

I have to suppress the actual output for column `Ref` because the API authentication key is visible in the URLs.

### Get further details on a specific train

The reference URLs available in `$departureBoardRef$Ref` or `$arrivalBoardRef$Ref` can now be used to get additional information on a certain train like 

* all stops on a train's journey,
* coordinates and succession of these stations and
* arrival and departure times for each station.

```{r, include = F}
dep <- departureBoard(stopID = stopID, 
                      date = "2016-09-01", 
                      time = "08:00", 
                      authKey = authKey, 
                      refs = TRUE)
```

```{r}
url <- dep$departureBoardRef$Ref[1]
journeyDetails(ref = url)
```

## How `journeyDetails()` can be used

Since `journeyDetails()` includes coordinates and the succession of stops one can use `ggplot2` and `geom_path` to (roughly) plot a train's journey on a map:

```{r, message = F}
# Store journey details
journey <- journeyDetails(ref = url)

library(ggplot2)
library(ggmap)

# Get a map of Germany
ger <- get_map(location = c(5.14,47.13,15.36,55.25), zoom = 6, maptype = "toner-background")

ggmap(ger) +
  geom_point(data = journey, 
             aes(x = lon, 
                 y = lat), 
             size = 3, 
             colour = "blue", 
             alpha= 0.6) +
  geom_path(data = journey, 
            aes(x = lon, 
                y = lat), 
            size = 1, 
            colour = "blue", 
            alpha = 0.4)
```

[^1]: My authentication key is stored in my `.GlobalEnv` as `authKey`.

